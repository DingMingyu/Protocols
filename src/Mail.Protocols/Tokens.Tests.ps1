using module .\Tokens.psm1

Describe "Get-O365Token" -Tags "Unit" {
  It "combines upn and access token" {
    $accessToken = "eyJ0eXAiOiJKV1QiLCJub25jZSI6ImR5ZGtITXZuUHZrc1ROZ3Z3QWdvVk1aaFdoekMtTVJNeE9HMDctVmlIcUUiLCJhbGciOiJSUzI1NiIsIng1dCI6Ii1LSTNROW5OUjdiUm9meG1lWm9YcWJIWkdldyIsImtpZCI6Ii1LSTNROW5OUjdiUm9meG1lWm9YcWJIWkdldyJ9.eyJhdWQiOiJodHRwczovL291dGxvb2sub2ZmaWNlLmNvbSIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0L2E0NDVmYjA4LTUwODQtNGYxZi1hNjQ1LTZiZGUxNTNlZDEzNy8iLCJpYXQiOjE2NzkxNDQ5OTEsIm5iZiI6MTY3OTE0NDk5MSwiZXhwIjoxNjc5MTUwNjY0LCJhY2N0IjowLCJhY3IiOiIxIiwiYWlvIjoiQVRRQXkvOFRBQUFBQlh0Y05DVEZOTUJUcTgzK0ZzWTl2Q2U0eXoxVE43TG15dTJDam9QR1JBREZ2TVFoc1dYVG40bHAvRDJEYzRQRyIsImFtciI6WyJwd2QiXSwiYXBwX2Rpc3BsYXluYW1lIjoiUG9wSW1hcF9NIiwiYXBwaWQiOiI2YjdiNDFjNi0wYzc3LTRlYjEtYTEyZi0xMzNkYmI3ZjgzYTAiLCJhcHBpZGFjciI6IjAiLCJlbmZwb2xpZHMiOltdLCJmYW1pbHlfbmFtZSI6IkFkbWluaXN0cmF0b3IiLCJnaXZlbl9uYW1lIjoiTU9EIiwiaXBhZGRyIjoiMTY3LjIyMC4yNTUuMTAiLCJuYW1lIjoiTU9EIEFkbWluaXN0cmF0b3IiLCJvaWQiOiIxM2UxZjZjMy1lYmRhLTQ4ZTItOTAxZS0zN2VkYzZkNWU3ZjAiLCJwdWlkIjoiMTAwMzIwMDIzNDFDM0FEMCIsInJoIjoiMC5BVllBQ1B0RnBJUlFIMC1tUld2ZUZUN1JOd0lBQUFBQUFQRVB6Z0FBQUFBQUFBQ2ZBS2suIiwic2NwIjoiSU1BUC5BY2Nlc3NBc1VzZXIuQWxsIFBPUC5BY2Nlc3NBc1VzZXIuQWxsIiwic2lkIjoiMWQ1ZDE4NzAtMjEyNy00YTYzLWI0MjctNzE0YmJiZDRiMmZiIiwic3ViIjoiUUxwR05VUFVqTllzak10STJZN3RYeVFuLXJGSF9jbTJBQzhTTTB2N2xfbyIsInRpZCI6ImE0NDVmYjA4LTUwODQtNGYxZi1hNjQ1LTZiZGUxNTNlZDEzNyIsInVuaXF1ZV9uYW1lIjoiYWRtaW5ATTM2NXg0Mzk2MzYwMi5vbm1pY3Jvc29mdC5jb20iLCJ1cG4iOiJhZG1pbkBNMzY1eDQzOTYzNjAyLm9ubWljcm9zb2Z0LmNvbSIsInV0aSI6InJMeGw0ckZkNGttVl94aXFRdjA5QUEiLCJ2ZXIiOiIxLjAiLCJ3aWRzIjpbIjYyZTkwMzk0LTY5ZjUtNDIzNy05MTkwLTAxMjE3NzE0NWUxMCIsImI3OWZiZjRkLTNlZjktNDY4OS04MTQzLTc2YjE5NGU4NTUwOSJdfQ.PCLnllA4vVrKH21gD3MVWw6oAK8uBoMSmaJwCs3nDGQwPh6Yy_NXBn6CHutDm4ebDruT46WoFoFoO2oUaRbrJu7rJxNPpZMFHly8fkn9sYQPbd6AAX8lCk38nwDRl8b7QlSvtWI0HYlSoV329R1-ymS1KvuujjnvNPgQR71onvp4DU4pTcPzIU0uo937LY9S5UyjhpudtnVAYi9F6dcMuzaX4dHctCEgr9U9jZ2Hfv631sBPZb30uEIuJB76QgC2DMjHsUQgiflvkwlIz0YPX_CTtUZuQZqjiiC2RZDT1luCh1PRVwZKJGDTqnhDFQiMQF8fFsmyR1qZpqz1GDj-NA"
    $upn = "admin@M365x43963602.onmicrosoft.com"
    $token = Get-O365Token -AccessToken $accessToken -Upn $upn
    $token | Should be "dXNlcj1hZG1pbkBNMzY1eDQzOTYzNjAyLm9ubWljcm9zb2Z0LmNvbQFhdXRoPUJlYXJlciBleUowZVhBaU9pSktWMVFpTENKdWIyNWpaU0k2SW1SNVpHdElUWFp1VUhacmMxUk9aM1ozUVdkdlZrMWFhRmRvZWtNdFRWSk5lRTlITURjdFZtbEljVVVpTENKaGJHY2lPaUpTVXpJMU5pSXNJbmcxZENJNklpMUxTVE5ST1c1T1VqZGlVbTltZUcxbFdtOVljV0pJV2tkbGR5SXNJbXRwWkNJNklpMUxTVE5ST1c1T1VqZGlVbTltZUcxbFdtOVljV0pJV2tkbGR5SjkuZXlKaGRXUWlPaUpvZEhSd2N6b3ZMMjkxZEd4dmIyc3ViMlptYVdObExtTnZiU0lzSW1semN5STZJbWgwZEhCek9pOHZjM1J6TG5kcGJtUnZkM011Ym1WMEwyRTBORFZtWWpBNExUVXdPRFF0TkdZeFppMWhOalExTFRaaVpHVXhOVE5sWkRFek55OGlMQ0pwWVhRaU9qRTJOemt4TkRRNU9URXNJbTVpWmlJNk1UWTNPVEUwTkRrNU1Td2laWGh3SWpveE5qYzVNVFV3TmpZMExDSmhZMk4wSWpvd0xDSmhZM0lpT2lJeElpd2lZV2x2SWpvaVFWUlJRWGt2T0ZSQlFVRkJRbGgwWTA1RFZFWk9UVUpVY1RnekswWnpXVGwyUTJVMGVYb3hWRTQzVEcxNWRUSkRhbTlRUjFKQlJFWjJUVkZvYzFkWVZHNDBiSEF2UkRKRVl6UlFSeUlzSW1GdGNpSTZXeUp3ZDJRaVhTd2lZWEJ3WDJScGMzQnNZWGx1WVcxbElqb2lVRzl3U1cxaGNGOU5JaXdpWVhCd2FXUWlPaUkyWWpkaU5ERmpOaTB3WXpjM0xUUmxZakV0WVRFeVppMHhNek5rWW1JM1pqZ3pZVEFpTENKaGNIQnBaR0ZqY2lJNklqQWlMQ0psYm1ad2IyeHBaSE1pT2x0ZExDSm1ZVzFwYkhsZmJtRnRaU0k2SWtGa2JXbHVhWE4wY21GMGIzSWlMQ0puYVhabGJsOXVZVzFsSWpvaVRVOUVJaXdpYVhCaFpHUnlJam9pTVRZM0xqSXlNQzR5TlRVdU1UQWlMQ0p1WVcxbElqb2lUVTlFSUVGa2JXbHVhWE4wY21GMGIzSWlMQ0p2YVdRaU9pSXhNMlV4Wmpaak15MWxZbVJoTFRRNFpUSXRPVEF4WlMwek4yVmtZelprTldVM1pqQWlMQ0p3ZFdsa0lqb2lNVEF3TXpJd01ESXpOREZETTBGRU1DSXNJbkpvSWpvaU1DNUJWbGxCUTFCMFJuQkpVbEZJTUMxdFVsZDJaVVpVTjFKT2QwbEJRVUZCUVVGUVJWQjZaMEZCUVVGQlFVRkJRMlpCUzJzdUlpd2ljMk53SWpvaVNVMUJVQzVCWTJObGMzTkJjMVZ6WlhJdVFXeHNJRkJQVUM1QlkyTmxjM05CYzFWelpYSXVRV3hzSWl3aWMybGtJam9pTVdRMVpERTROekF0TWpFeU55MDBZVFl6TFdJME1qY3ROekUwWW1KaVpEUmlNbVppSWl3aWMzVmlJam9pVVV4d1IwNVZVRlZxVGxsemFrMTBTVEpaTjNSWWVWRnVMWEpHU0Y5amJUSkJRemhUVFRCMk4yeGZieUlzSW5ScFpDSTZJbUUwTkRWbVlqQTRMVFV3T0RRdE5HWXhaaTFoTmpRMUxUWmlaR1V4TlRObFpERXpOeUlzSW5WdWFYRjFaVjl1WVcxbElqb2lZV1J0YVc1QVRUTTJOWGcwTXprMk16WXdNaTV2Ym0xcFkzSnZjMjltZEM1amIyMGlMQ0oxY0c0aU9pSmhaRzFwYmtCTk16WTFlRFF6T1RZek5qQXlMbTl1YldsamNtOXpiMlowTG1OdmJTSXNJblYwYVNJNkluSk1lR3cwY2taa05HdHRWbDk0YVhGUmRqQTVRVUVpTENKMlpYSWlPaUl4TGpBaUxDSjNhV1J6SWpwYklqWXlaVGt3TXprMExUWTVaalV0TkRJek55MDVNVGt3TFRBeE1qRTNOekUwTldVeE1DSXNJbUkzT1daaVpqUmtMVE5sWmprdE5EWTRPUzA0TVRRekxUYzJZakU1TkdVNE5UVXdPU0pkZlEuUENMbmxsQTR2VnJLSDIxZ0QzTVZXdzZvQUs4dUJvTVNtYUp3Q3MzbkRHUXdQaDZZeV9OWEJuNkNIdXREbTRlYkRydVQ0NldvRm9Gb08yb1VhUmJySnU3ckp4TlBwWk1GSGx5OGZrbjlzWVFQYmQ2QUFYOGxDazM4bndEUmw4YjdRbFN2dFdJMEhZbFNvVjMyOVIxLXltUzFLdnV1ampudk5QZ1FSNzFvbnZwNERVNHBUY1B6SVUwdW85MzdMWTlTNVV5amhwdWR0blZBWWk5RjZkY011emFYNGRIY3RDRWdyOVU5aloySGZ2NjMxc0JQWmIzMHVFSXVKQjc2UWdDMkRNakhzVVFnaWZsdmt3bEl6MFlQWF9DVHRVWnVRWnFqaWlDMlJaRFQxbHVDaDFQUlZ3WktKR0RUcW5oREZRaU1RRjhmRnNteVIxcVpwcXoxR0RqLU5BAQE="
  }
}
